name: CI

on: [push]

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        version: [5.1, 5.2, 5.3, 5.4, 5.5, master]
        staging: [-staging, ""]

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    - name: clone wine ${{ matrix.version }}
      if: matrix.version != 'master'
      run: git clone https://github.com/wine-mirror/wine --depth 1 -b wine-${{ matrix.version }}
    - name: clone wine (for master only)
      if: matrix.version == 'master'
      run: git clone https://github.com/wine-mirror/wine --depth 1
    - name: get staging ${{ matrix.version }}
      if: matrix.staging == '-staging' && matrix.version != 'master'
      run: git clone https://github.com/wine-staging/wine-staging --depth 1 -b v${{ matrix.version }}
    - name: get staging (for master only)
      if: matrix.staging == '-staging' && matrix.version == 'master'
      run: git clone https://github.com/wine-staging/wine-staging --depth 1 
    - name: install build-essential
      run: sudo apt-get install build-essential flex bison
    - name: apply patch
      run: |
        cd wine
        git apply $PWD/../headless.patch
    - name: apply staging patch
      if: matrix.staging == '-staging'
      run: |
        root=$PWD
        cd wine-staging/patches
        ./patchinstall.sh DESTDIR=$root/wine --all -W user32-rawinput-hid -W user32-rawinput-mouse -W user32-rawinput-mouse-experimental -W user32-rawinput-nolegacy
    - name: configure
      run: |
        cd wine
        ./configure \
          --without-alsa \
          --without-capi \
          --without-cms \
          --without-coreaudio \
          --without-cups \
          --without-curses \
          --without-dbus \
          --without-faudio \
          --without-gettext \
          --without-gphoto \
          --without-glu \
          --without-gnutls \
          --without-gsm \
          --without-gssapi \
          --without-gstreamer \
          --without-hal \
          --without-inotify \
          --without-jpeg \
          --without-krb5 \
          --without-ldap \
          --without-mingw \
          --without-mpg123 \
          --without-netapi \
          --without-openal \
          --without-opencl \
          --without-opengl \
          --without-osmesa \
          --without-oss \
          --without-pcap \
          --without-pulse \
          --without-sane \
          --without-sdl \
          --without-tiff \
          --without-udev \
          --without-unwind \
          --without-v4l2 \
          --without-vkd3d \
          --without-vulkan \
          --without-xcomposite \
          --without-xcursor \
          --without-xfixes \
          --without-xinerama \
          --without-xinput \
          --without-xinput2 \
          --without-xml \
          --without-xrandr \
          --without-xrender \
          --without-xshape \
          --without-xshm \
          --without-xslt \
          --disable-tests \
          --disable-maintainer_mode \
          --disable-werror \
          --disable-largefile \
          --disable-acledit \
          --disable-aclui \
          --disable-activeds_tlb \
          --disable-activeds \
          --disable-actxprxy \
          --disable-adsiid \
          --disable-adsldp \
          --disable-adsldpc \
          --disable-advpack \
          --disable-amsi \
          --disable-amstream \
          --disable-apphelp \
          --disable-appwiz_cpl \
          --disable-atl \
          --disable-atl100 \
          --disable-atl110 \
          --disable-atl80 \
          --disable-atl90 \
          --disable-atlthunk \
          --disable-atmlib \
          --disable-authz \
          --disable-avicap32 \
          --disable-avifil32 \
          --disable-avrt \
          --disable-bluetoothapis \
          --disable-browseui \
          --disable-bthprops_cpl \
          --disable-cabinet \
          --disable-capi2032 \
          --disable-cards \
          --disable-cdosys \
          --disable-cfgmgr32 \
          --disable-clusapi \
          --disable-combase \
          --disable-comcat \
          --disable-comctl32 \
          --disable-comdlg32 \
          --disable-compstui \
          --disable-comsvcs \
          --disable-connect \
          --disable-credui \
          --disable-crypt32 \
          --disable-cryptdlg \
          --disable-cryptdll \
          --disable-cryptext \
          --disable-cryptnet \
          --disable-cryptui \
          --disable-ctapi32 \
          --disable-ctl3d32 \
          --disable-d2d1 \
          --disable-d3d10 \
          --disable-d3d10_1 \
          --disable-d3d10core \
          --disable-d3d11 \
          --disable-d3d12 \
          --disable-d3d8 \
          --disable-d3d9 \
          --disable-d3dcompiler_33 \
          --disable-d3dcompiler_34 \
          --disable-d3dcompiler_35 \
          --disable-d3dcompiler_36 \
          --disable-d3dcompiler_37 \
          --disable-d3dcompiler_38 \
          --disable-d3dcompiler_39 \
          --disable-d3dcompiler_40 \
          --disable-d3dcompiler_41 \
          --disable-d3dcompiler_42 \
          --disable-d3dcompiler_43 \
          --disable-d3dcompiler_46 \
          --disable-d3dcompiler_47 \
          --disable-d3dim \
          --disable-d3drm \
          --disable-d3dx10_33 \
          --disable-d3dx10_34 \
          --disable-d3dx10_35 \
          --disable-d3dx10_36 \
          --disable-d3dx10_37 \
          --disable-d3dx10_38 \
          --disable-d3dx10_39 \
          --disable-d3dx10_40 \
          --disable-d3dx10_41 \
          --disable-d3dx10_42 \
          --disable-d3dx10_43 \
          --disable-d3dx11_42 \
          --disable-d3dx11_43 \
          --disable-d3dx9_24 \
          --disable-d3dx9_25 \
          --disable-d3dx9_26 \
          --disable-d3dx9_27 \
          --disable-d3dx9_28 \
          --disable-d3dx9_29 \
          --disable-d3dx9_30 \
          --disable-d3dx9_31 \
          --disable-d3dx9_32 \
          --disable-d3dx9_33 \
          --disable-d3dx9_34 \
          --disable-d3dx9_35 \
          --disable-d3dx9_36 \
          --disable-d3dx9_37 \
          --disable-d3dx9_38 \
          --disable-d3dx9_39 \
          --disable-d3dx9_40 \
          --disable-d3dx9_41 \
          --disable-d3dx9_42 \
          --disable-d3dx9_43 \
          --disable-d3dxof \
          --disable-davclnt \
          --disable-dbgeng \
          --disable-dciman32 \
          --disable-ddraw \
          --disable-ddrawex \
          --disable-devenum \
          --disable-dhcpcsvc \
          --disable-dhtmled_ocx \
          --disable-difxapi \
          --disable-dinput \
          --disable-dinput8 \
          --disable-dispex \
          --disable-dmband \
          --disable-dmcompos \
          --disable-dmime \
          --disable-dmloader \
          --disable-dmoguids \
          --disable-dmscript \
          --disable-dmstyle \
          --disable-dmsynth \
          --disable-dmusic \
          --disable-dmusic32 \
          --disable-dnsapi \
          --disable-dplay \
          --disable-dplayx \
          --disable-dpnaddr \
          --disable-dpnet \
          --disable-dpnhpast \
          --disable-dpnlobby \
          --disable-dpvoice \
          --disable-dpwsockx \
          --disable-drmclien \
          --disable-dsdmo \
          --disable-dsound \
          --disable-dsquery \
          --disable-dssenh \
          --disable-dswave \
          --disable-dwmapi \
          --disable-dwrite \
          --disable-dx8vb \
          --disable-dxdiagn \
          --disable-dxerr8 \
          --disable-dxerr9 \
          --disable-dxgi \
          --disable-dxguid \
          --disable-dxva2 \
          --disable-esent \
          --disable-evr \
          --disable-explorerframe \
          --disable-ext_ms_win_authz_context_l1_1_0 \
          --disable-ext_ms_win_domainjoin_netjoin_l1_1_0 \
          --disable-ext_ms_win_dwmapi_ext_l1_1_0 \
          --disable-ext_ms_win_gdi_dc_create_l1_1_0 \
          --disable-ext_ms_win_gdi_dc_create_l1_1_1 \
          --disable-ext_ms_win_gdi_dc_l1_2_0 \
          --disable-ext_ms_win_gdi_devcaps_l1_1_0 \
          --disable-ext_ms_win_gdi_draw_l1_1_0 \
          --disable-ext_ms_win_gdi_draw_l1_1_1 \
          --disable-ext_ms_win_gdi_font_l1_1_0 \
          --disable-ext_ms_win_gdi_font_l1_1_1 \
          --disable-ext_ms_win_gdi_render_l1_1_0 \
          --disable-ext_ms_win_kernel32_package_current_l1_1_0 \
          --disable-ext_ms_win_kernel32_package_l1_1_1 \
          --disable-ext_ms_win_ntuser_dialogbox_l1_1_0 \
          --disable-ext_ms_win_ntuser_draw_l1_1_0 \
          --disable-ext_ms_win_ntuser_gui_l1_1_0 \
          --disable-ext_ms_win_ntuser_gui_l1_3_0 \
          --disable-ext_ms_win_ntuser_keyboard_l1_3_0 \
          --disable-ext_ms_win_ntuser_message_l1_1_0 \
          --disable-ext_ms_win_ntuser_message_l1_1_1 \
          --disable-ext_ms_win_ntuser_misc_l1_1_0 \
          --disable-ext_ms_win_ntuser_misc_l1_2_0 \
          --disable-ext_ms_win_ntuser_misc_l1_5_1 \
          --disable-ext_ms_win_ntuser_mouse_l1_1_0 \
          --disable-ext_ms_win_ntuser_private_l1_1_1 \
          --disable-ext_ms_win_ntuser_private_l1_3_1 \
          --disable-ext_ms_win_ntuser_rectangle_ext_l1_1_0 \
          --disable-ext_ms_win_ntuser_uicontext_ext_l1_1_0 \
          --disable-ext_ms_win_ntuser_window_l1_1_0 \
          --disable-ext_ms_win_ntuser_window_l1_1_1 \
          --disable-ext_ms_win_ntuser_window_l1_1_4 \
          --disable-ext_ms_win_ntuser_windowclass_l1_1_0 \
          --disable-ext_ms_win_ntuser_windowclass_l1_1_1 \
          --disable-ext_ms_win_oleacc_l1_1_0 \
          --disable-ext_ms_win_ras_rasapi32_l1_1_0 \
          --disable-ext_ms_win_rtcore_gdi_devcaps_l1_1_0 \
          --disable-ext_ms_win_rtcore_gdi_object_l1_1_0 \
          --disable-ext_ms_win_rtcore_gdi_rgn_l1_1_0 \
          --disable-ext_ms_win_rtcore_ntuser_cursor_l1_1_0 \
          --disable-ext_ms_win_rtcore_ntuser_dc_access_l1_1_0 \
          --disable-ext_ms_win_rtcore_ntuser_dpi_l1_1_0 \
          --disable-ext_ms_win_rtcore_ntuser_dpi_l1_2_0 \
          --disable-ext_ms_win_rtcore_ntuser_rawinput_l1_1_0 \
          --disable-ext_ms_win_rtcore_ntuser_syscolors_l1_1_0 \
          --disable-ext_ms_win_rtcore_ntuser_sysparams_l1_1_0 \
          --disable-ext_ms_win_security_credui_l1_1_0 \
          --disable-ext_ms_win_security_cryptui_l1_1_0 \
          --disable-ext_ms_win_shell_comctl32_init_l1_1_0 \
          --disable-ext_ms_win_shell_comdlg32_l1_1_0 \
          --disable-ext_ms_win_shell_shell32_l1_2_0 \
          --disable-ext_ms_win_uxtheme_themes_l1_1_0 \
          --disable-faultrep \
          --disable-feclient \
          --disable-fltlib \
          --disable-fltmgr_sys \
          --disable-fntcache \
          --disable-fontsub \
          --disable-fusion \
          --disable-fwpuclnt \
          --disable-gameux \
          --disable-gdiplus \
          --disable-glu32 \
          --disable-gphoto2_ds \
          --disable-gpkcsp \
          --disable-hal \
          --disable-hhctrl_ocx \
          --disable-hid \
          --disable-hidclass_sys \
          --disable-hlink \
          --disable-hnetcfg \
          --disable-http_sys \
          --disable-httpapi \
          --disable-iccvid \
          --disable-icmp \
          --disable-ieframe \
          --disable-ieproxy \
          --disable-imaadp32_acm \
          --disable-imagehlp \
          --disable-inetcomm \
          --disable-inetcpl_cpl \
          --disable-inetmib1 \
          --disable-infosoft \
          --disable-initpki \
          --disable-inkobj \
          --disable-inseng \
          --disable-iprop \
          --disable-irprops_cpl \
          --disable-itircl \
          --disable-itss \
          --disable-joy_cpl \
          --disable-jscript \
          --disable-jsproxy \
          --disable-kerberos \
          --disable-ksecdd_sys \
          --disable-ksuser \
          --disable-ktmw32 \
          --disable-l3codeca_acm \
          --disable-loadperf \
          --disable-localspl \
          --disable-localui \
          --disable-lz32 \
          --disable-mapi32 \
          --disable-mapistub \
          --disable-mciavi32 \
          --disable-mcicda \
          --disable-mciqtz32 \
          --disable-mciseq \
          --disable-mciwave \
          --disable-mf \
          --disable-mf3216 \
          --disable-mferror \
          --disable-mfmediaengine \
          --disable-mfplat \
          --disable-mfplay \
          --disable-mfreadwrite \
          --disable-mfuuid \
          --disable-mgmtapi \
          --disable-midimap \
          --disable-mlang \
          --disable-mmcndmgr \
          --disable-mmdevapi \
          --disable-mountmgr_sys \
          --disable-mp3dmod \
          --disable-mprapi \
          --disable-msacm32_drv \
          --disable-msacm32 \
          --disable-msado15 \
          --disable-msadp32_acm \
          --disable-msasn1 \
          --disable-mscat32 \
          --disable-mscms \
          --disable-mscorwks \
          --disable-msctf \
          --disable-msctfp \
          --disable-msdaps \
          --disable-msdelta \
          --disable-msdmo \
          --disable-msdrm \
          --disable-msftedit \
          --disable-msg711_acm \
          --disable-msgsm32_acm \
          --disable-mshtml_tlb \
          --disable-mshtml \
          --disable-msi \
          --disable-msident \
          --disable-msimg32 \
          --disable-msimsg \
          --disable-msimtf \
          --disable-msisip \
          --disable-msisys_ocx \
          --disable-msls31 \
          --disable-msnet32 \
          --disable-mspatcha \
          --disable-msports \
          --disable-msrle32 \
          --disable-msscript_ocx \
          --disable-mssign32 \
          --disable-mssip32 \
          --disable-mstask \
          --disable-msvcirt \
          --disable-msvfw32 \
          --disable-msvidc32 \
          --disable-msxml \
          --disable-msxml2 \
          --disable-msxml3 \
          --disable-msxml4 \
          --disable-msxml6 \
          --disable-mtxdm \
          --disable-ncrypt \
          --disable-nddeapi \
          --disable-ndis_sys \
          --disable-netapi32 \
          --disable-netcfgx \
          --disable-netprofm \
          --disable-newdev \
          --disable-ninput \
          --disable-normaliz \
          --disable-npmshtml \
          --disable-npptools \
          --disable-ntdsapi \
          --disable-ntoskrnl_exe \
          --disable-ntprint \
          --disable-objsel \
          --disable-odbc32 \
          --disable-odbcbcp \
          --disable-odbccp32 \
          --disable-odbccu32 \
          --disable-oleacc \
          --disable-oleaut32 \
          --disable-olecli32 \
          --disable-oledb32 \
          --disable-oledlg \
          --disable-olepro32 \
          --disable-olesvr32 \
          --disable-olethk32 \
          --disable-opcservices \
          --disable-openal32 \
          --disable-opencl \
          --disable-opengl32 \
          --disable-packager \
          --disable-pdh \
          --disable-photometadatahandler \
          --disable-pidgen \
          --disable-powrprof \
          --disable-printui \
          --disable-prntvpt \
          --disable-propsys \
          --disable-pstorec \
          --disable-qasf \
          --disable-qcap \
          --disable-qedit \
          --disable-qmgr \
          --disable-qmgrprxy \
          --disable-quartz \
          --disable-query \
          --disable-qwave \
          --disable-rasapi32 \
          --disable-rasdlg \
          --disable-regapi \
          --disable-resutils \
          --disable-riched20 \
          --disable-riched32 \
          --disable-rsabase \
          --disable-rsaenh \
          --disable-rstrtmgr \
          --disable-rtutils \
          --disable-rtworkq \
          --disable-samlib \
          --disable-sane_ds \
          --disable-sapi \
          --disable-sas \
          --disable-scarddlg \
          --disable-sccbase \
          --disable-schannel \
          --disable-schedsvc \
          --disable-scrobj \
          --disable-scrrun \
          --disable-scsiport_sys \
          --disable-secur32 \
          --disable-security \
          --disable-sensapi \
          --disable-serialui \
          --disable-sfc \
          --disable-sfc_os \
          --disable-shdoclc \
          --disable-shdocvw \
          --disable-shfolder \
          --disable-slbcsp \
          --disable-slc \
          --disable-snmpapi \
          --disable-softpub \
          --disable-spoolss \
          --disable-srclient \
          --disable-sspicli \
          --disable-stdole2_tlb \
          --disable-stdole32_tlb \
          --disable-sti \
          --disable-strmbase \
          --disable-strmdll \
          --disable-strmiids \
          --disable-svrapi \
          --disable-sxs \
          --disable-t2embed \
          --disable-tapi32 \
          --disable-taskschd \
          --disable-tdh \
          --disable-tdi_sys \
          --disable-traffic \
          --disable-twain_32 \
          --disable-tzres \
          --disable-uianimation \
          --disable-uiautomationcore \
          --disable-uiribbon \
          --disable-unicows \
          --disable-updspapi \
          --disable-url \
          --disable-urlmon \
          --disable-usbd_sys \
          --disable-userenv \
          --disable-usp10 \
          --disable-utildll \
          --disable-uxtheme \
          --disable-vbscript \
          --disable-vcomp \
          --disable-vcomp100 \
          --disable-vcomp110 \
          --disable-vcomp120 \
          --disable-vcomp140 \
          --disable-vcomp90 \
          --disable-vcruntime140 \
          --disable-vcruntime140_1 \
          --disable-vdmdbg \
          --disable-vga \
          --disable-virtdisk \
          --disable-vssapi \
          --disable-vulkan_1 \
          --disable-wbemdisp \
          --disable-wbemprox \
          --disable-wbemuuid \
          --disable-wdscore \
          --disable-webservices \
          --disable-wer \
          --disable-wevtapi \
          --disable-wiaservc \
          --disable-wimgapi \
          --disable-windowscodecs \
          --disable-windowscodecsext \
          --disable-winealsa_drv \
          --disable-wineandroid_drv \
          --disable-winebus_sys \
          --disable-winecoreaudio_drv \
          --disable-wined3d \
          --disable-winegstreamer \
          --disable-winehid_sys \
          --disable-winejoystick_drv \
          --disable-winemac_drv \
          --disable-winemapi \
          --disable-wineoss_drv \
          --disable-wineps_drv \
          --disable-winepulse_drv \
          --disable-wineqtdecoder \
          --disable-winevulkan \
          --disable-winex11_drv \
          --disable-wing32 \
          --disable-winhttp \
          --disable-winmm \
          --disable-winnls32 \
          --disable-winscard \
          --disable-winspool_drv \
          --disable-winsta \
          --disable-wintab32 \
          --disable-wintrust \
          --disable-winusb \
          --disable-wlanapi \
          --disable-wlanui \
          --disable-wldap32 \
          --disable-wmasf \
          --disable-wmcodecdspuuid \
          --disable-wmi \
          --disable-wmiutils \
          --disable-wmp \
          --disable-wmphoto \
          --disable-wmvcore \
          --disable-wnaspi32 \
          --disable-wpc \
          --disable-wpcap \
          --disable-wsdapi \
          --disable-wshom_ocx \
          --disable-wsnmp32 \
          --disable-wsock32 \
          --disable-wtsapi32 \
          --disable-wuapi \
          --disable-wuaueng \
          --disable-x3daudio1_0 \
          --disable-x3daudio1_1 \
          --disable-x3daudio1_2 \
          --disable-x3daudio1_3 \
          --disable-x3daudio1_4 \
          --disable-x3daudio1_5 \
          --disable-x3daudio1_6 \
          --disable-x3daudio1_7 \
          --disable-xapofx1_1 \
          --disable-xapofx1_2 \
          --disable-xapofx1_3 \
          --disable-xapofx1_4 \
          --disable-xapofx1_5 \
          --disable-xaudio2_0 \
          --disable-xaudio2_1 \
          --disable-xaudio2_2 \
          --disable-xaudio2_3 \
          --disable-xaudio2_4 \
          --disable-xaudio2_5 \
          --disable-xaudio2_6 \
          --disable-xaudio2_7 \
          --disable-xaudio2_8 \
          --disable-xaudio2_9 \
          --disable-xinput1_1 \
          --disable-xinput1_2 \
          --disable-xinput1_3 \
          --disable-xinput1_4 \
          --disable-xinput9_1_0 \
          --disable-xmllite \
          --disable-xolehlp \
          --disable-xpsprint \
          --disable-xpssvcs \
          --disable-fonts \
          --disable-po \
          --disable-arp \
          --disable-aspnet_regiis \
          --disable-attrib \
          --disable-cabarc \
          --disable-cacls \
          --disable-chcp_com \
          --disable-clock \
          --disable-cmd \
          --disable-conhost \
          --disable-control \
          --disable-cscript \
          --disable-dism \
          --disable-dpnsvr \
          --disable-dxdiag \
          --disable-eject \
          --disable-expand \
          --disable-explorer \
          --disable-extrac32 \
          --disable-fc \
          --disable-find \
          --disable-findstr \
          --disable-fsutil \
          --disable-hh \
          --disable-hostname \
          --disable-icacls \
          --disable-icinfo \
          --disable-iexplore \
          --disable-ipconfig \
          --disable-lodctr \
          --disable-mofcomp \
          --disable-mshta \
          --disable-msidb \
          --disable-msiexec \
          --disable-msinfo32 \
          --disable-net \
          --disable-netsh \
          --disable-netstat \
          --disable-ngen \
          --disable-notepad \
          --disable-oleview \
          --disable-ping \
          --disable-plugplay \
          --disable-powershell \
          --disable-presentationfontcache \
          --disable-progman \
          --disable-reg \
          --disable-regasm \
          --disable-regedit \
          --disable-regini \
          --disable-regsvcs \
          --disable-regsvr32 \
          --disable-rpcss \
          --disable-rundll32 \
          --disable-sc \
          --disable-schtasks \
          --disable-sdbinst \
          --disable-secedit \
          --disable-servicemodelreg \
          --disable-services \
          --disable-shutdown \
          --disable-spoolsv \
          --disable-start \
          --disable-subst \
          --disable-svchost \
          --disable-systeminfo \
          --disable-taskkill \
          --disable-tasklist \
          --disable-taskmgr \
          --disable-termsv \
          --disable-uninstaller \
          --disable-unlodctr \
          --disable-view \
          --disable-wevtutil \
          --disable-whoami \
          --disable-winebrowser \
          --disable-winecfg \
          --disable-wineconsole \
          --disable-winedbg \
          --disable-winedevice \
          --disable-winefile \
          --disable-winemenubuilder \
          --disable-winemine \
          --disable-winemsibuilder \
          --disable-winepath \
          --disable-winetest \
          --disable-winhlp32 \
          --disable-winmgmt \
          --disable-winver \
          --disable-wmic \
          --disable-wmplayer \
          --disable-wordpad \
          --disable-write \
          --disable-wscript \
          --disable-wuauserv \
          --disable-wusa \
          --disable-xcopy \
          --disable-sfnt2fon \
          --enable-win64 \
          --prefix=$(pwd)/../dist
    - name: build
      run: |
        cd wine
        make -j4
    - name: install
      run: |
        mkdir dist
        pushd wine
        make install
        popd
        tar cvfJ wine.tar.xz dist/*
    - name: Upload artifact ${{ matrix.version }}
      uses: actions/upload-artifact@v1.0.0
      with:
        name: ${{ matrix.version }}${{ matrix.staging }}
        path: dist
    - name: Create a new GitHub release if a new tag is pushed
      uses: svenstaro/upload-release-action@v1-release
      if: startsWith(github.ref, 'refs/tags/')
      with:
        repo_token: ${{ secrets.GITHUB_TOKEN }}
        file: wine.tar.xz
        asset_name: wine-${{ matrix.version }}${{ matrix.staging }}.tar.xz
        tag: ${{ github.ref }}
        overwrite: true
